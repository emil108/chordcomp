<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

    <title>Chord comping using MIDI sustain pedal</title>

    <script src='js/WebAudioFontPlayer.js'></script>
    <!-- <script src='https://surikov.github.io/webaudiofontdata/sound/0250_SoundBlasterOld_sf2.js'></script> -->
    <!-- <script src='js/soundfonts/0040_JCLive_sf2_file.js'></script> -->


</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col text-center">
                <div id="divSorry">&nbsp;</div>
                <button class="btn btn-primary" id="btnGo" type="button">Initialize</button>
                <div style="font-size:78px;font-family:sans-serif;text-align: center;" id="p1"></div>
                <div><textarea id="taLog" class="form-control" rows="6" style="font-family: monospace"
                        readonly></textarea></div>
            </div>

        </div>

    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous">
    </script>

    <script>
        //    var instrument = _tone_0250_SoundBlasterOld_sf2;
        var instrumentIndex = 208; //896; //181; //182;
        var instrument;
        if (!("requestMIDIAccess" in navigator)) {
            document.write(
                "<h3>This browser does not support WebMIDI, check <a href='https://caniuse.com/#feat=midi'>current Web MIDI support</a>. Chrome browser works, for example.</h3>"
            );
        }

        function pedalDown() {
            var dec = decodedChords[song[currentIndex]];
            logIt("Pedal down");
            player.queueChord(audioContext, output, instrument, 0, dec, 999);
            document.getElementById("p1").innerHTML = song[currentIndex];
        }

        function pedalUp() {
            player.cancelQueue(audioContext);
            logIt("Pedal up");
            currentIndex++;
            if (currentIndex >= song.length) {
                currentIndex = 0;
            }
        }

        var currentIndex = 0;
        var song = ["Am7", "D7", "Gmaj7", "Cmaj7",
            "F#m7b5", "B7", "Em", "Em",
            "Am7", "D7", "Gmaj7", "Cmaj7",
            "F#m7b5", "B7", "Em", "Em",
            "F#m7b5", "B7b9", "Em", "Em",
            "Am7", "D7", "Gmaj7", "Gmaj7",
            "F#m7b5", "B7b9", "Em7", "Eb7", "Dm7", "Db7",
            "Cmaj7", "B7b9", "Em", "Em"
        ];
        var chords = {
            "Am7": ["A3", "G4", "C5"],
            "D7": ["D3", "C3", "F#4"],
            "Gmaj7": ["G3", "F#4", "B4"],
            "Cmaj7": ["C3", "B3", "E4"],
            "F#m7b5": ["F#3", "C4", "E4", "A4"],
            "B7": ["B2", "A3", "D#4"],
            "Em": ["E3", "B3", "G4"],
            "B7b9": ["B2", "A3", "C", "D#4"],
            "Em7": ["E3", "D4", "G4"],
            "Eb7": ["Eb3", "Db4", "G4"],
            "Dm7": ["D3", "C4", "F4"],
            "Db7": ["Db3", "B3", "F4"],
        };
        var decodedChords = {};

        function decodeChords(chords) {
            var decoded = {};
            for (var i in chords) {
                decoded[i] = [];
                for (var j = 0; j < chords[i].length; j++) {
                    decoded[i].push(getMIDINote(chords[i][j]));
                }
            }
            return decoded;
        }

        function getMIDINote(noteString) {
            var base = {
                "C": 0,
                "C#": 1,
                "Db": 1,
                "D": 2,
                "D#": 3,
                "Eb": 3,
                "E": 4,
                "Fb": 4,
                "F": 5,
                "F#": 6,
                "Gb": 6,
                "G": 7,
                "G#": 8,
                "Ab": 8,
                "A": 9,
                "A#": 10,
                "Bb": 10,
                "B": 11,
                "Cb": 11
            }
            var parts = noteString.match(/([A-G](?:#|b)?)(\d+)/);
            if (!parts) {
                return false;
            }
            return base[parts[1]] + 12 * (parseInt(parts[2]) + 1);
        }

        var AudioContextFunc = window.AudioContext || window.webkitAudioContext;
        var audioContext;
        var output;
        var player;
        decodedChords = decodeChords(chords);

        $(function () {
            logIt("Hi, press Initialize to begin.");
            $("#btnGo").on("click", function () {
                go();
            });
        });

        var noMidiDevices = 0;

        function go() {
            navigator.requestMIDIAccess()
                .then((access) => {

                    // Get lists of available MIDI controllers
                    const inputs = access.inputs;
                    const inputsValues = access.inputs.values();

                    var count = 0;
                    for (var input = inputsValues.next(); input && !input.done; input = inputsValues.next()) {
                        var deviceName = input.value.name;
                        logIt("Found " + deviceName);
                        count++;
                    }
                    if (!count) {
                        logIt("No MIDI devices found, sorry.");
                        noMidiDevices = 1;
                    }
                    inputs.forEach((midiInput) => {
                        midiInput.onmidimessage = function (message) {
                            var status = message.data[0];
                            var data1 = message.data[1];
                            var data2 = message.data[2];
                            if (status == 176 && data1 == 64 && data2 == 127) {
                                pedalDown();
                            }
                            if (status == 176 && data1 == 64 && data2 == 0) {
                                pedalUp();
                            }
                        }
                    })
                });



            // var env = player.queueWaveTable(audioContext, output, _tone_0250_SoundBlasterOld_sf2, 0, 12 * 4 + 7, 2);
            // queueChord()
            // player.queueChord(audioContext, output, instrument, 0, [60, 67], 1.5);
            audioContext = new AudioContextFunc();
            output = audioContext.destination;
            player = new WebAudioFontPlayer();

            var info2 = player.loader.instrumentInfo(instrumentIndex);
            player.loader.startLoad(audioContext, info2.url, info2.variable);
            player.loader.waitLoad(function () {
                if (!noMidiDevices) {
                    logIt('Initialization done, press the sustain pedal to hear the first chord.', info2);
                }
                instrument = window[info2.variable];
                player.loader.decodeAfterLoading(audioContext, info2.variable);
                for (var i = 0; i < instrument.zones.length; i++) {
                    instrument.zones[i].ahdsr = false;
                }
            });

        }

        function logIt(s) {
            $("#taLog").append(s + "\n");
        }
    </script>

</body>

</html>